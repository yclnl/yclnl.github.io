{"version":3,"file":"index.modern.js","sources":["../src/index.js"],"sourcesContent":["import EventEmitter from 'eventemitter3';\nimport { PublicKey } from '@solana/web3.js';\nimport bs58 from 'bs58';\n\nexport default class Wallet extends EventEmitter {\n  constructor(providerUrl, network) {\n    super();\n    this._providerUrl = new URL(providerUrl);\n    this._providerUrl.hash = new URLSearchParams({\n      origin: window.location.origin,\n      network,\n    }).toString();\n    this._publicKey = null;\n    this._autoApprove = false;\n    this._popup = null;\n    this._handlerAdded = false;\n    this._nextRequestId = 1;\n    this._responsePromises = new Map();\n  }\n\n  _handleMessage = (e) => {\n    if (e.origin === this._providerUrl.origin && e.source === this._popup) {\n      if (e.data.method === 'connected') {\n        const newPublicKey = new PublicKey(e.data.params.publicKey);\n        if (!this._publicKey || !this._publicKey.equals(newPublicKey)) {\n          this._handleDisconnect();\n          this._publicKey = newPublicKey;\n          this._autoApprove = !!e.data.params.autoApprove;\n          this.emit('connect', this._publicKey);\n        }\n      } else if (e.data.method === 'disconnected') {\n        this._handleDisconnect();\n      } else if (e.data.result || e.data.error) {\n        if (this._responsePromises.has(e.data.id)) {\n          const [resolve, reject] = this._responsePromises.get(e.data.id);\n          if (e.data.result) {\n            resolve(e.data.result);\n          } else {\n            reject(new Error(e.data.error));\n          }\n        }\n      }\n    }\n  };\n\n  _handleDisconnect = () => {\n    if (this._publicKey) {\n      this._publicKey = null;\n      this.emit('disconnect');\n    }\n    this._responsePromises.forEach(([resolve, reject], id) => {\n      this._responsePromises.delete(id);\n      reject('Wallet disconnected');\n    });\n  };\n\n  _sendRequest = async (method, params) => {\n    if (!this.connected) {\n      throw new Error('Wallet not connected');\n    }\n    const requestId = this._nextRequestId;\n    ++this._nextRequestId;\n    return new Promise((resolve, reject) => {\n      this._responsePromises.set(requestId, [resolve, reject]);\n      this._popup.postMessage(\n        {\n          jsonrpc: '2.0',\n          id: requestId,\n          method,\n          params,\n        },\n        this._providerUrl.origin,\n      );\n      if (!this.autoApprove) {\n        this._popup.focus();\n      }\n    });\n  };\n\n  get publicKey() {\n    return this._publicKey;\n  }\n\n  get connected() {\n    return this._publicKey !== null;\n  }\n\n  get autoApprove() {\n    return this._autoApprove;\n  }\n\n  connect = () => {\n    if (this._popup) {\n      this._popup.close();\n    }\n    if (!this._handlerAdded) {\n      this._handlerAdded = true;\n      window.addEventListener('message', this._handleMessage);\n      window.addEventListener('beforeunload', this.disconnect);\n    }\n    window.name = 'parent';\n    this._popup = window.open(\n      this._providerUrl.toString(),\n      '_blank',\n      'location,resizable,width=460,height=675',\n    );\n    return new Promise((resolve) => {\n      this.once('connect', resolve);\n    });\n  };\n\n  disconnect = () => {\n    if (this._popup) {\n      this._popup.close();\n    }\n    this._handleDisconnect();\n  };\n\n  signTransaction = async (transaction) => {\n    const response = await this._sendRequest('signTransaction', {\n      message: bs58.encode(transaction.serializeMessage()),\n    });\n    const signature = bs58.decode(response.signature);\n    const publicKey = new PublicKey(response.publicKey);\n    transaction.addSignature(publicKey, signature);\n    return transaction;\n  };\n}\n"],"names":["Wallet","EventEmitter","constructor","providerUrl","network","_handleMessage","e","origin","_providerUrl","source","_popup","data","method","newPublicKey","PublicKey","params","publicKey","_publicKey","equals","_handleDisconnect","_autoApprove","autoApprove","emit","result","error","_responsePromises","has","id","resolve","reject","get","Error","forEach","delete","_sendRequest","connected","requestId","_nextRequestId","Promise","set","postMessage","jsonrpc","focus","connect","close","_handlerAdded","window","addEventListener","disconnect","name","open","toString","once","signTransaction","transaction","response","message","bs58","encode","serializeMessage","signature","decode","addSignature","URL","hash","URLSearchParams","location","Map"],"mappings":";;;;AAIe,MAAMA,MAAN,SAAqBC,YAArB,CAAkC;AAC/CC,EAAAA,WAAW,CAACC,WAAD,EAAcC,OAAd,EAAuB;AAAA;;AAChC,WADgC;AAAA;;AAAA,SAelCC,cAfkC,GAehBC,CAAD,IAAO;AACtB,UAAIA,CAAC,CAACC,MAAF,KAAa,KAAKC,YAAL,CAAkBD,MAA/B,IAAyCD,CAAC,CAACG,MAAF,KAAa,KAAKC,MAA/D,EAAuE;AACrE,YAAIJ,CAAC,CAACK,IAAF,CAAOC,MAAP,KAAkB,WAAtB,EAAmC;AACjC,gBAAMC,YAAY,GAAG,IAAIC,SAAJ,CAAcR,CAAC,CAACK,IAAF,CAAOI,MAAP,CAAcC,SAA5B,CAArB;;AACA,cAAI,CAAC,KAAKC,UAAN,IAAoB,CAAC,KAAKA,UAAL,CAAgBC,MAAhB,CAAuBL,YAAvB,CAAzB,EAA+D;AAC7D,iBAAKM,iBAAL;;AACA,iBAAKF,UAAL,GAAkBJ,YAAlB;AACA,iBAAKO,YAAL,GAAoB,CAAC,CAACd,CAAC,CAACK,IAAF,CAAOI,MAAP,CAAcM,WAApC;AACA,iBAAKC,IAAL,CAAU,SAAV,EAAqB,KAAKL,UAA1B;AACD;AACF,SARD,MAQO,IAAIX,CAAC,CAACK,IAAF,CAAOC,MAAP,KAAkB,cAAtB,EAAsC;AAC3C,eAAKO,iBAAL;AACD,SAFM,MAEA,IAAIb,CAAC,CAACK,IAAF,CAAOY,MAAP,IAAiBjB,CAAC,CAACK,IAAF,CAAOa,KAA5B,EAAmC;AACxC,cAAI,KAAKC,iBAAL,CAAuBC,GAAvB,CAA2BpB,CAAC,CAACK,IAAF,CAAOgB,EAAlC,CAAJ,EAA2C;AACzC,kBAAM,CAACC,OAAD,EAAUC,MAAV,IAAoB,KAAKJ,iBAAL,CAAuBK,GAAvB,CAA2BxB,CAAC,CAACK,IAAF,CAAOgB,EAAlC,CAA1B;;AACA,gBAAIrB,CAAC,CAACK,IAAF,CAAOY,MAAX,EAAmB;AACjBK,cAAAA,OAAO,CAACtB,CAAC,CAACK,IAAF,CAAOY,MAAR,CAAP;AACD,aAFD,MAEO;AACLM,cAAAA,MAAM,CAAC,IAAIE,KAAJ,CAAUzB,CAAC,CAACK,IAAF,CAAOa,KAAjB,CAAD,CAAN;AACD;AACF;AACF;AACF;AACF,KAtCiC;;AAAA,SAwClCL,iBAxCkC,GAwCd,MAAM;AACxB,UAAI,KAAKF,UAAT,EAAqB;AACnB,aAAKA,UAAL,GAAkB,IAAlB;AACA,aAAKK,IAAL,CAAU,YAAV;AACD;;AACD,WAAKG,iBAAL,CAAuBO,OAAvB,CAA+B,CAAC,CAACJ,OAAD,EAAUC,MAAV,CAAD,EAAoBF,EAApB,KAA2B;AACxD,aAAKF,iBAAL,CAAuBQ,MAAvB,CAA8BN,EAA9B;;AACAE,QAAAA,MAAM,CAAC,qBAAD,CAAN;AACD,OAHD;AAID,KAjDiC;;AAAA,SAmDlCK,YAnDkC,GAmDnB,gBAAOtB,MAAP,EAAeG,MAAf,EAA0B;AACvC,UAAI,CAAC,KAAI,CAACoB,SAAV,EAAqB;AACnB,cAAM,IAAIJ,KAAJ,CAAU,sBAAV,CAAN;AACD;;AACD,YAAMK,SAAS,GAAG,KAAI,CAACC,cAAvB;AACA,QAAE,KAAI,CAACA,cAAP;AACA,aAAO,IAAIC,OAAJ,CAAY,CAACV,OAAD,EAAUC,MAAV,KAAqB;AACtC,QAAA,KAAI,CAACJ,iBAAL,CAAuBc,GAAvB,CAA2BH,SAA3B,EAAsC,CAACR,OAAD,EAAUC,MAAV,CAAtC;;AACA,QAAA,KAAI,CAACnB,MAAL,CAAY8B,WAAZ,CACE;AACEC,UAAAA,OAAO,EAAE,KADX;AAEEd,UAAAA,EAAE,EAAES,SAFN;AAGExB,UAAAA,MAHF;AAIEG,UAAAA;AAJF,SADF,EAOE,KAAI,CAACP,YAAL,CAAkBD,MAPpB;;AASA,YAAI,CAAC,KAAI,CAACc,WAAV,EAAuB;AACrB,UAAA,KAAI,CAACX,MAAL,CAAYgC,KAAZ;AACD;AACF,OAdM,CAAP;AAeD,KAxEiC;;AAAA,SAsFlCC,OAtFkC,GAsFxB,MAAM;AACd,UAAI,KAAKjC,MAAT,EAAiB;AACf,aAAKA,MAAL,CAAYkC,KAAZ;AACD;;AACD,UAAI,CAAC,KAAKC,aAAV,EAAyB;AACvB,aAAKA,aAAL,GAAqB,IAArB;AACAC,QAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmC,KAAK1C,cAAxC;AACAyC,QAAAA,MAAM,CAACC,gBAAP,CAAwB,cAAxB,EAAwC,KAAKC,UAA7C;AACD;;AACDF,MAAAA,MAAM,CAACG,IAAP,GAAc,QAAd;AACA,WAAKvC,MAAL,GAAcoC,MAAM,CAACI,IAAP,CACZ,KAAK1C,YAAL,CAAkB2C,QAAlB,EADY,EAEZ,QAFY,EAGZ,yCAHY,CAAd;AAKA,aAAO,IAAIb,OAAJ,CAAaV,OAAD,IAAa;AAC9B,aAAKwB,IAAL,CAAU,SAAV,EAAqBxB,OAArB;AACD,OAFM,CAAP;AAGD,KAxGiC;;AAAA,SA0GlCoB,UA1GkC,GA0GrB,MAAM;AACjB,UAAI,KAAKtC,MAAT,EAAiB;AACf,aAAKA,MAAL,CAAYkC,KAAZ;AACD;;AACD,WAAKzB,iBAAL;AACD,KA/GiC;;AAAA,SAiHlCkC,eAjHkC,GAiHhB,gBAAOC,WAAP,EAAuB;AACvC,YAAMC,QAAQ,GAAG,MAAM,KAAI,CAACrB,YAAL,CAAkB,iBAAlB,EAAqC;AAC1DsB,QAAAA,OAAO,EAAEC,IAAI,CAACC,MAAL,CAAYJ,WAAW,CAACK,gBAAZ,EAAZ;AADiD,OAArC,CAAvB;AAGA,YAAMC,SAAS,GAAGH,IAAI,CAACI,MAAL,CAAYN,QAAQ,CAACK,SAArB,CAAlB;AACA,YAAM5C,SAAS,GAAG,IAAIF,SAAJ,CAAcyC,QAAQ,CAACvC,SAAvB,CAAlB;AACAsC,MAAAA,WAAW,CAACQ,YAAZ,CAAyB9C,SAAzB,EAAoC4C,SAApC;AACA,aAAON,WAAP;AACD,KAzHiC;;AAEhC,SAAK9C,YAAL,GAAoB,IAAIuD,GAAJ,CAAQ5D,WAAR,CAApB;AACA,SAAKK,YAAL,CAAkBwD,IAAlB,GAAyB,IAAIC,eAAJ,CAAoB;AAC3C1D,MAAAA,MAAM,EAAEuC,MAAM,CAACoB,QAAP,CAAgB3D,MADmB;AAE3CH,MAAAA;AAF2C,KAApB,EAGtB+C,QAHsB,EAAzB;AAIA,SAAKlC,UAAL,GAAkB,IAAlB;AACA,SAAKG,YAAL,GAAoB,KAApB;AACA,SAAKV,MAAL,GAAc,IAAd;AACA,SAAKmC,aAAL,GAAqB,KAArB;AACA,SAAKR,cAAL,GAAsB,CAAtB;AACA,SAAKZ,iBAAL,GAAyB,IAAI0C,GAAJ,EAAzB;AACD;;AA6DD,MAAInD,SAAJ,GAAgB;AACd,WAAO,KAAKC,UAAZ;AACD;;AAED,MAAIkB,SAAJ,GAAgB;AACd,WAAO,KAAKlB,UAAL,KAAoB,IAA3B;AACD;;AAED,MAAII,WAAJ,GAAkB;AAChB,WAAO,KAAKD,YAAZ;AACD;;AArF8C;;;;"}